# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Project Overview

Zoolan VetMgmt (PetCare) is a full-stack veterinary management system built with:
- **Backend**: Spring Boot 3.5.0, Java 21
- **Frontend**: Vaadin Flow 24.8.3 (Pure Java UI framework)
- **Database**: PostgreSQL 16 with Flyway migrations
- **Reporting**: JasperReports for PDF generation
- **Build Tool**: Maven

## Essential Commands (Makefile)

The project includes a Makefile for common operations:

### Development

```bash
# Start application with database (recommended)
make run

# Restart application with clean database
make restart

# Start application manually after database is up
make db-up
./mvnw

# Start with debug port (5630)
./mvnw -Dspring-boot.run.jvmArguments="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5630"
```

### Building & Production

```bash
# Build for production using Makefile
make build

# Package project into JAR
make package

# Build for production (includes Vaadin production bundle)
./mvnw clean package -Pproduction

# Build without tests
./mvnw clean package -DskipTests -Pproduction

# Build Docker image
docker build -t cristiandelahooz/petcare:latest .
```

### Testing

```bash
# Run all tests using Makefile
make test

# Run all tests manually
./mvnw test

# Run specific test class
./mvnw test -Dtest=ArchitectureTest

# Run integration tests with Testcontainers
./mvnw verify -Pintegration-test
```

### Code Quality

```bash
# Format code using Makefile
make format

# Format Java code with Spotless
./mvnw spotless:apply

# Check code formatting
./mvnw spotless:check
```

### Database Management

```bash
# Database operations using Makefile
make db-up        # Start PostgreSQL container
make db-down      # Stop PostgreSQL container
make db-clean     # Clean database volumes (fresh start)
make db-restart   # Restart with clean database
make db-shell     # Connect to PostgreSQL shell
make db-logs      # View PostgreSQL logs

# Clean everything and restart
make clean        # Clean build artifacts
make restart      # Clean project and database, then restart

# Flyway migrations
./mvnw flyway:migrate
./mvnw flyway:validate

# Current migration strategy (development phase)
# Two migration files are currently in use:
# - src/main/resources/db/migration/prod/V0.0.1__init.sql (schema)
# - src/main/resources/db/migration/dev/V1.0.1__dev_data.sql (test data)
```

### JasperReports

```bash
# Compile .jrxml reports to .jasper
./mvnw process-sources

# Reports are compiled from: src/main/resources/reports/
# Output to: src/main/resources/reports/*.jasper
```

### Dependency Management

```bash
# Install local FullCalendar JARs (required for build)
mvn install:install-file -Dfile=libs/fullcalendar2-7.0.0.jar -DgroupId=org.vaadin.stefan -DartifactId=fullcalendar2 -Dversion=7.0.0 -Dpackaging=jar
mvn install:install-file -Dfile=libs/fullcalendar2-scheduler-7.0.0.jar -DgroupId=org.vaadin.stefan -DartifactId=fullcalendar2-scheduler -Dversion=7.0.0 -Dpackaging=jar

# Update dependencies
./mvnw versions:display-dependency-updates

# Download dependencies for offline work
./mvnw dependency:go-offline -Pproduction
```

## Architecture & Structure

### Backend Architecture (Spring Boot)

```
src/main/java/com/wornux/
├── components/         # Reusable UI components
├── constants/          # Application constants
├── data/              
│   ├── base/          # Base entities (auditable, etc.)
│   ├── entity/        # JPA entities
│   ├── enums/         # Enumerations
│   └── repository/    # Spring Data repositories
├── dto/               
│   ├── report/        # Report DTOs
│   ├── request/       # Request DTOs
│   └── response/      # Response DTOs
├── exception/         # Custom exceptions
├── mapper/            # MapStruct mappers
├── security/          
│   └── auditable/     # Audit support
├── services/          
│   ├── implementations/
│   ├── interfaces/    
│   └── report/        # JasperReports services
├── utils/             # Utility classes
├── validation/        # Custom validators
└── views/             # Vaadin views
    ├── appointments/  # Appointment management
    ├── auth/          # Authentication views
    ├── clients/       # Client management
    ├── consultations/ # Medical consultations
    ├── employees/     # Employee management
    ├── inventory/     # Inventory tracking
    ├── medicalhistory/# Medical records
    ├── pets/          # Pet management
    ├── products/      # Product catalog
    ├── suppliers/     # Supplier management
    ├── transactions/  # Invoicing
    ├── waitingroom/   # Waiting room
    └── warehouses/    # Warehouse management
```

### Frontend Architecture (Vaadin Flow)

```
src/main/frontend/
├── themes/zoolan-vetmgmt/   # Custom Vaadin theme
│   ├── components/          # Component-specific CSS
│   └── view/               # View-specific CSS
└── generated/              # Auto-generated by Vaadin (do not edit)

src/main/java/com/wornux/views/
├── MainLayout.java         # Main application layout
├── DashboardView.java      # Main dashboard
└── [module]/              # View classes per module (Java-based UI)
```

### Key Design Patterns

1. **Service Layer Pattern**: All business logic in service classes
2. **Repository Pattern**: Data access through Spring Data JPA repositories
3. **DTO Pattern**: Separate request/response DTOs with MapStruct mapping
4. **Auditable Entities**: Automatic tracking of created/modified timestamps and users
5. **Envers Auditing**: Full audit trail for all entities

## Database Schema

- **PostgreSQL 16** with Flyway migrations
- **Audit tables**: Each entity has a corresponding `_log` table (Hibernate Envers)
- **Migration Strategy** (Development Phase):
  - Currently using two main migration files:
    - `V0.0.1__init.sql` in `prod/`: Database schema creation
    - `V1.0.1__dev_data.sql` in `dev/`: Development test data
  - Once ready for production, migrations will be properly versioned
- **Migrations**: Located in `src/main/resources/db/migration/`
  - `prod/`: Production migrations (schema)
  - `dev/`: Development-only migrations (test data)

## Deployment

### Local Development
```bash
# Start database
docker compose up -d

# Run application
./mvnw
```

### Production Deployment
The application uses GitHub Actions for CI/CD:
1. Push to `main` branch triggers deployment
2. Builds Docker image and pushes to Docker Hub
3. Deploys to DigitalOcean droplet via SSH
4. Sends Telegram notifications

Environment variables required:
- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`
- `SPRING_PROFILES_ACTIVE=production`

## Key Technologies & Dependencies

### Backend
- **Spring Boot 3.5.0**: Core framework
- **Spring Security**: Authentication/authorization
- **Spring Data JPA**: Database access
- **Hibernate 6.6.4**: ORM with Envers for auditing
- **MapStruct 1.5.5**: Object mapping
- **Lombok**: Boilerplate reduction
- **JasperReports 7.0.1**: PDF report generation

### Frontend
- **Vaadin Flow 24.8.3**: Java-based UI framework (no JavaScript/React needed)
- **FullCalendar 7.0.0**: Calendar/scheduling component
- **Line Awesome 2.1.0**: Icon library
- **Lumo Theme**: Vaadin's design system

### Testing
- **JUnit 5**: Unit testing
- **Testcontainers**: Integration testing
- **ArchUnit 1.4.1**: Architecture testing

## Security Considerations

1. **Spring Security**: All endpoints protected except `/login`
2. **Password Hashing**: BCrypt for password storage
3. **Audit Trail**: All entity changes tracked via Hibernate Envers
4. **Session Management**: Vaadin handles session security
5. **CSRF Protection**: Enabled by default in Spring Security

## Maven Caching (for CI/CD)

When using GitHub Actions or other CI systems, include Maven cache:
```yaml
cache: maven  # As specified in the user's rules
```

## Common Issues & Solutions

### FullCalendar Dependencies Not Found
Install local JARs from `libs/` directory (see Dependency Management commands)

### Frontend Not Updating
1. Clear browser cache
2. Run `./mvnw vaadin:clean-frontend`
3. Rebuild with `./mvnw clean compile`

### Database Connection Issues
Check PostgreSQL is running: `docker compose ps`
Verify credentials in `application.yml`

### Out of Memory During Build
Increase Maven memory: `export MAVEN_OPTS="-Xmx2048m"`

## Development Workflow

1. **Feature Development**:
   - Create feature branch from `main`
   - Make changes (backend and/or frontend)
   - Test locally with `./mvnw test`
   - Format code with `./mvnw spotless:apply`

2. **Database Changes**:
   - Create migration in `src/main/resources/db/migration/prod/`
   - Test migration locally
   - Include rollback script if complex

3. **UI Development**:
   - Vaadin Flow views in `src/main/java/com/wornux/views/` (Java classes)
   - Component styles in `src/main/frontend/themes/zoolan-vetmgmt/`
   - All UI is built with Java, no JavaScript/React required

4. **Report Development**:
   - Design in JasperStudio
   - Save `.jrxml` in `src/main/resources/reports/`
   - Compile with `./mvnw process-sources`
